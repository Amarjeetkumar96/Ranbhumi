---
- name: Fullstack App Deployment on WSL
  hosts: localhost
  connection: local
  gather_facts: yes

  vars:
    k8s_manifest_path: "../k8s/fullstackdeployment.yaml"
    frontend_service_name: frontend
    backend_service_name: backend
    frontend_nodeport: 30082
    backend_nodeport: 30083

  tasks:

    - name: Gather system facts
      ansible.builtin.setup:

    - name: Ensure Docker service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes

    - name: Start Minikube (if not running)
      shell: |
        if ! minikube status --output=json 2>/dev/null | grep -q '"Host": "Running"'; then
          echo "Starting Minikube using Docker driver..."
          minikube start --driver=docker --memory=4000 --cpus=2
        else
          echo "Minikube already running."
        fi
      args:
        executable: /bin/bash

    - name: Copy Kubernetes deployment file
      ansible.builtin.copy:
        src: "{{ k8s_manifest_path }}"
        dest: /tmp/fullstackdeployment.yaml
        force: yes

    - name: Apply Kubernetes manifests
      shell: kubectl apply -f /tmp/fullstackdeployment.yaml
      args:
        executable: /bin/bash

    - name: Wait for all pods to be ready
      shell: |
        kubectl wait --for=condition=ready pod --all --timeout=180s
      args:
        executable: /bin/bash

    - name: Display all Kubernetes services
      shell: kubectl get svc -o wide
      register: svc_output
      args:
        executable: /bin/bash

    - name: Print services table
      debug:
        msg: "{{ svc_output.stdout }}"

    # -------------------------------
    # PORT FORWARDING (background)
    # -------------------------------

    - name: Kill any existing port-forward processes
      shell: pkill -f "kubectl port-forward" || true
      args:
        executable: /bin/bash

    - name: Forward backend NodePort 30083 -> Service port 8081 (background)
      shell: |
        nohup kubectl port-forward svc/{{ backend_service_name }} {{ backend_nodeport }}:8081 >/dev/null 2>&1 &
      args:
        executable: /bin/bash

    - name: Forward frontend NodePort 30082 -> Service port 80 (background)
      shell: |
        nohup kubectl port-forward svc/{{ frontend_service_name }} {{ frontend_nodeport }}:80 >/dev/null 2>&1 &
      args:
        executable: /bin/bash

    - name: Show access URLs
      debug:
        msg:
          - "ğŸŒ Frontend: http://localhost:{{ frontend_nodeport }}/Ranbhumi/"
          - "ğŸš€ Backend:  http://localhost:{{ backend_nodeport }}/"
